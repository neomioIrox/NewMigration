<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DB Migration Helper - Project Table</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        h1 {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .panel {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
        }

        .panel h2 {
            color: #667eea;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .table-selector {
            margin-bottom: 20px;
        }

        .table-selector label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }

        .table-selector select {
            width: 100%;
            padding: 10px;
            border: 2px solid #667eea;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            cursor: pointer;
        }

        .table-selector select:focus {
            outline: none;
            border-color: #764ba2;
        }

        .table-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }

        .table-card h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 18px;
        }

        .table-card.old-db {
            border-left-color: #764ba2;
        }

        .columns-list {
            background: white;
            border-radius: 4px;
            padding: 10px;
            margin-top: 10px;
        }

        .column-item {
            padding: 8px 12px;
            margin: 5px 0;
            background: #e9ecef;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .column-row {
            padding: 12px;
            margin: 8px 0;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }

        .column-name {
            font-family: 'Courier New', monospace;
            font-size: 14px;
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
        }

        .mapping-selectors {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .mapping-selectors select {
            padding: 8px;
            border: 2px solid #667eea;
            border-radius: 6px;
            font-size: 13px;
            background: white;
            cursor: pointer;
        }

        .mapping-selectors select:focus {
            outline: none;
            border-color: #764ba2;
        }

        .mapping-selectors input {
            padding: 8px;
            border: 2px solid #6c757d;
            border-radius: 6px;
            font-size: 13px;
            background: #f8f9fa;
            grid-column: 1 / -1;
        }

        .mapping-selectors input:focus {
            outline: none;
            border-color: #495057;
            background: white;
        }

        .const-label {
            grid-column: 1 / -1;
            font-size: 12px;
            color: #6c757d;
            font-weight: bold;
            margin-bottom: 4px;
        }

        .default-value-input {
            grid-column: 1 / -1;
            margin-top: 8px;
            padding: 6px;
            border: 1px dashed #6c757d;
            border-radius: 4px;
            background: #f9f9f9;
        }

        .default-value-input label {
            font-size: 11px;
            color: #6c757d;
            margin-bottom: 4px;
            display: block;
        }

        .default-value-input input {
            width: 100%;
            padding: 6px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            font-size: 12px;
        }

        .fk-mapping-section {
            grid-column: 1 / -1;
            margin-top: 8px;
            padding: 8px;
            background: #e9ecef;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .fk-mapping-section label {
            font-size: 12px;
            color: #495057;
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
        }

        .fk-mapping-section input[type="checkbox"] {
            cursor: pointer;
        }

        .fk-mapping-btn {
            padding: 4px 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }

        .fk-mapping-btn:hover {
            background: #5568d3;
        }

        .fk-mapping-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .column-item:hover {
            background: #d3d7db;
            transform: translateX(5px);
        }

        .column-item.selectable:hover {
            background: #667eea;
            color: white;
        }

        .column-item.selected {
            background: #28a745;
            color: white;
            font-weight: bold;
        }

        .fk-badge {
            display: inline-block;
            background: #ffc107;
            color: #333;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            margin-left: 8px;
            font-weight: bold;
        }

        .section {
            margin-bottom: 20px;
        }

        .section-title {
            color: #495057;
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: white;
            font-size: 18px;
        }

        .scrollable {
            max-height: 600px;
            overflow-y: auto;
        }

        .scrollable::-webkit-scrollbar {
            width: 8px;
        }

        .scrollable::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .scrollable::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 4px;
        }

        .no-data {
            padding: 20px;
            text-align: center;
            color: #6c757d;
            font-style: italic;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 20px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(108, 117, 125, 0.3);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            color: #667eea;
            margin: 0;
        }

        .close-btn {
            font-size: 28px;
            font-weight: bold;
            color: #aaa;
            cursor: pointer;
            border: none;
            background: none;
        }

        .close-btn:hover {
            color: #000;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            font-size: 14px;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .connection-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .connection-section h3 {
            color: #495057;
            margin-bottom: 15px;
        }

        .status-message {
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
            font-size: 14px;
        }

        .status-message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .migration-section {
            border-top: 2px solid #dee2e6;
            padding-top: 20px;
            margin-top: 20px;
        }

        .fk-modal {
            z-index: 2000;
        }

        .fk-modal .modal-content {
            max-width: 90%;
            width: 1200px;
        }

        .fk-table-container {
            max-height: 500px;
            overflow: auto;
            margin-top: 20px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
        }

        .fk-mapping-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .fk-mapping-table th {
            position: sticky;
            top: 0;
            background: #667eea;
            color: white;
            padding: 10px;
            text-align: left;
            font-weight: 600;
            z-index: 10;
        }

        .fk-mapping-table td {
            padding: 8px 10px;
            border-bottom: 1px solid #dee2e6;
        }

        .fk-mapping-table tr:hover {
            background: #f8f9fa;
        }

        .fk-mapping-table input[type="text"] {
            width: 100%;
            padding: 4px 8px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
        }

        .fk-mapping-table input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }

        /* Localization Accordion Styles */
        .localization-accordion {
            margin-top: 30px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .accordion-header {
            width: 100%;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }

        .accordion-header:hover {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
        }

        .accordion-content {
            padding: 20px;
            background: white;
        }

        /* Language Tabs */
        .language-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #dee2e6;
        }

        .tab-btn {
            padding: 12px 24px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            color: #6c757d;
            transition: all 0.3s;
        }

        .tab-btn:hover {
            color: #667eea;
            background: #f8f9fa;
        }

        .tab-btn.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .tab-content h3 {
            color: #495057;
            margin-bottom: 20px;
            font-size: 18px;
        }

        /* Expression Input Styles */
        .expression-input {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }

        .expression-input label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #495057;
        }

        .expression-input textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            resize: vertical;
            min-height: 80px;
        }

        .expression-input textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .expression-input small {
            display: block;
            margin-top: 8px;
            font-size: 12px;
        }

        .expression-input small a {
            color: #667eea;
            text-decoration: none;
            margin: 0 5px;
        }

        .expression-input small a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Database Migration Helper - Project Table Analysis</h1>

        <div class="action-buttons">
            <button class="btn btn-primary" onclick="openConnectionModal()">×”×’×“×¨×•×ª ×—×™×‘×•×¨ ×•××™×’×¨×¦×™×”</button>
            <button class="btn btn-success" onclick="openSaveMappingModal()">×©××•×¨ ××™×¤×•×™</button>
            <button class="btn btn-warning" onclick="openLoadMappingModal()">×˜×¢×Ÿ ××™×¤×•×™</button>
            <button class="btn btn-secondary" onclick="clearLogs()">×¨×•×§×Ÿ ×§×•×‘×¥ ×œ×•×’</button>
        </div>

        <div id="loading" class="loading">Loading project table data...</div>

        <div id="content" style="display: none;">
            <div class="main-grid">
                <!-- New DB Panel - Full Width -->
                <div class="panel" style="grid-column: 1 / -1;">
                    <h2>Project Table - Field Mapping</h2>
                    <div class="scrollable">
                        <div id="newDbContent"></div>
                    </div>
                </div>
            </div>

            <!-- projectLocalization Accordion -->
            <div class="localization-accordion">
                <button class="accordion-header" onclick="toggleLocalizationAccordion()">
                    <span>ğŸ“ projectLocalization Mapping (3 Languages)</span>
                    <span id="localizationToggleIcon">â–¼</span>
                </button>
                <div id="localizationContent" class="accordion-content" style="display: none;">
                    <!-- Language Tabs -->
                    <div class="language-tabs">
                        <button class="tab-btn active" onclick="switchLanguageTab('hebrew')">×¢×‘×¨×™×ª (Hebrew)</button>
                        <button class="tab-btn" onclick="switchLanguageTab('english')">English</button>
                        <button class="tab-btn" onclick="switchLanguageTab('french')">FranÃ§ais (French)</button>
                    </div>

                    <!-- Tab Content -->
                    <div id="hebrewTab" class="tab-content active">
                        <h3>Hebrew Localization Fields (Language ID: 1)</h3>
                        <div id="hebrewFields"></div>
                    </div>

                    <div id="englishTab" class="tab-content">
                        <h3>English Localization Fields (Language ID: 2)</h3>
                        <div id="englishFields"></div>
                    </div>

                    <div id="frenchTab" class="tab-content">
                        <h3>French Localization Fields (Language ID: 3)</h3>
                        <div id="frenchFields"></div>
                    </div>
                </div>
            </div>

            <!-- ProjectItem Accordion -->
            <div class="localization-accordion" style="margin-top: 20px;">
                <button class="accordion-header" onclick="toggleProjectItemAccordion()">
                    <span>ğŸ”§ ProjectItem Mapping (Funds & Collections)</span>
                    <span id="projectItemToggleIcon">â–¼</span>
                </button>
                <div id="projectItemContent" class="accordion-content" style="display: none;">
                    <p style="color: #28a745; padding: 10px; background: #d4edda; border-radius: 4px; margin-bottom: 15px;">
                        âœ… ProjectItem mappings loaded from JSON file<br>
                        â€¢ <strong>Funds</strong> (ProjectType=1): Creates 1 FundDonation item per project<br>
                        â€¢ <strong>Collections</strong> (ProjectType=2): Creates 2 items (Certificate + Donation) per project
                    </p>

                    <h3>ProjectItem Fields Mapping</h3>
                    <div id="projectItemFields"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- FK Mapping Modal -->
    <div id="fkMappingModal" class="modal fk-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>××™×¤×•×™ FK ×œ×©×“×”: <span id="fkModalColumnName"></span></h2>
                <button class="close-btn" onclick="closeFkMappingModal()">&times;</button>
            </div>

            <div class="form-group">
                <label>×‘×—×¨ ×˜×‘×œ×” ××‘×¡×™×¡ ×”× ×ª×•× ×™× ×”×™×©×Ÿ:</label>
                <select id="fkSourceTable" onchange="onFkSourceTableChange()">
                    <option value="">-- Select Table --</option>
                </select>
            </div>

            <div class="form-group" id="fkKeyColumnGroup" style="display: none;">
                <label>×‘×—×¨ ×©×“×” ××–×”×” (×œ×”×©×•×•××” ×¢× ×”×¢×¨×š ×”×™×©×Ÿ):</label>
                <select id="fkKeyColumn" onchange="loadFkTableData()">
                    <option value="">-- Select Column --</option>
                </select>
            </div>

            <div id="fkTableDataContainer" class="fk-table-container" style="display: none;">
                <table class="fk-mapping-table" id="fkDataTable">
                    <thead id="fkTableHead"></thead>
                    <tbody id="fkTableBody"></tbody>
                </table>
            </div>

            <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="closeFkMappingModal()">×‘×™×˜×•×œ</button>
                <button class="btn btn-success" onclick="saveFkMapping()">×©××•×¨ ××™×¤×•×™</button>
            </div>
        </div>
    </div>

    <!-- Connection Settings Modal -->
    <div id="connectionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>×”×’×“×¨×•×ª ×—×™×‘×•×¨ ×•××™×’×¨×¦×™×”</h2>
                <button class="close-btn" onclick="closeConnectionModal()">&times;</button>
            </div>

            <!-- MSSQL Connection -->
            <div class="connection-section">
                <h3>×¤×¨×˜×™ ×—×™×‘×•×¨ ×œ-MSSQL (××¡×“ × ×ª×•× ×™× ×™×©×Ÿ)</h3>
                <div class="form-group">
                    <label>Server:</label>
                    <input type="text" id="mssqlServer" placeholder="localhost">
                </div>
                <div class="form-group">
                    <label>Database:</label>
                    <input type="text" id="mssqlDatabase" placeholder="OldDatabase">
                </div>
                <div class="form-group">
                    <label>Username:</label>
                    <input type="text" id="mssqlUser" placeholder="sa">
                </div>
                <div class="form-group">
                    <label>Password:</label>
                    <input type="password" id="mssqlPassword">
                </div>
                <button class="btn btn-primary" onclick="testMSSQLConnection()">×‘×“×™×§×ª ×—×™×‘×•×¨ ×œ-MSSQL</button>
                <div id="mssqlStatus"></div>
            </div>

            <!-- MySQL Connection -->
            <div class="connection-section">
                <h3>×¤×¨×˜×™ ×—×™×‘×•×¨ ×œ-MySQL (××¡×“ × ×ª×•× ×™× ×—×“×©)</h3>
                <div class="form-group">
                    <label>Host:</label>
                    <input type="text" id="mysqlHost" placeholder="localhost">
                </div>
                <div class="form-group">
                    <label>Database:</label>
                    <input type="text" id="mysqlDatabase" placeholder="NewDatabase">
                </div>
                <div class="form-group">
                    <label>Username:</label>
                    <input type="text" id="mysqlUser" placeholder="root">
                </div>
                <div class="form-group">
                    <label>Password:</label>
                    <input type="password" id="mysqlPassword">
                </div>
                <button class="btn btn-primary" onclick="testMySQLConnection()">×‘×“×™×§×ª ×—×™×‘×•×¨ ×œ-MySQL</button>
                <div id="mysqlStatus"></div>
            </div>

            <!-- Migration Section -->
            <div class="migration-section">
                <h3>×‘×™×¦×•×¢ ××™×’×¨×¦×™×”</h3>
                <p style="color: #6c757d; margin-bottom: 15px;">
                    ×”××™×’×¨×¦×™×” ×ª×¢×‘×™×¨ × ×ª×•× ×™× ××”××¡×“ ×”×™×©×Ÿ ×œ×—×“×© ×œ×¤×™ ×”××™×¤×•×™ ×©×”×’×“×¨×ª ×‘××¡×š ×”×¨××©×™.
                </p>
                <button class="btn btn-success" onclick="executeMigration()">×‘×¦×¢ ××™×’×¨×¦×™×”</button>
                <div id="migrationStatus"></div>
            </div>
        </div>
    </div>

    <!-- Save Mapping Modal -->
    <div id="saveMappingModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>×©××™×¨×ª ××™×¤×•×™</h2>
                <button class="close-btn" onclick="closeSaveMappingModal()">&times;</button>
            </div>

            <div class="form-group">
                <label>×©× ×§×•×‘×¥ ×”××™×¤×•×™:</label>
                <input type="text" id="mappingFilename" placeholder="×”×›× ×¡ ×©× (×œ×“×•×’××”: project_mapping_v1)">
                <p style="color: #6c757d; font-size: 13px; margin-top: 5px;">
                    ×”×§×•×‘×¥ ×™×™×©××¨ ×‘×ª×™×§×™×™×ª mappings ×¢× ×¡×™×•××ª .json
                </p>
            </div>

            <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="closeSaveMappingModal()">×‘×™×˜×•×œ</button>
                <button class="btn btn-success" onclick="saveCurrentMapping()">×©××•×¨</button>
            </div>
        </div>
    </div>

    <!-- Load Mapping Modal -->
    <div id="loadMappingModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>×˜×¢×™× ×ª ××™×¤×•×™</h2>
                <button class="close-btn" onclick="closeLoadMappingModal()">&times;</button>
            </div>

            <div id="mappingFilesList" style="max-height: 400px; overflow-y: auto;">
                <p style="text-align: center; color: #6c757d;">×˜×•×¢×Ÿ ×¨×©×™××ª ×§×‘×¦×™×...</p>
            </div>

            <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="closeLoadMappingModal()">×¡×’×•×¨</button>
            </div>
        </div>
    </div>

    <script>
        let allOldTables = [];
        let oldTablesData = {};
        let columnMappings = {};
        let currentFkColumn = null;
        let fkMappings = {};  // Store FK mappings per column
        let fkTableData = {};  // Store loaded table data
        let localizationMappings = {};  // Store localization mappings per field per language
        let localizationData = null;  // Store projectlocalization table structure
        let currentLanguage = 'hebrew';  // Current active tab
        let projectItemMappings = {};  // Store projectItem mappings (funds & collections)
        let projectItemData = null;  // Store projectItem table structure
        let currentItemType = 'funds';  // Current active item type tab
        let whereClause = null;  // WHERE clause filter for source query

        async function loadData() {
            try {
                // Load project table data
                const response = await fetch('/api/analyze/project');
                const data = await response.json();

                // Load all old table names
                const tablesResponse = await fetch('/api/old-tables');
                const tablesData = await tablesResponse.json();
                allOldTables = tablesData.tables;

                // Render New DB section
                await renderNewDB(data);

                document.getElementById('loading').style.display = 'none';
                document.getElementById('content').style.display = 'block';
            } catch (error) {
                document.getElementById('loading').innerHTML =
                    '<p style="color: white;">Error loading data: ' + error.message + '</p>';
            }
        }


        async function renderNewDB(data) {
            const container = document.getElementById('newDbContent');
            let html = '';

            // Create mapping lookup - prioritize loaded mappings over CSV data
            const mappingLookup = {};

            // First, load from CSV data (default)
            if (data.mappings) {
                data.mappings.forEach(m => {
                    if (m.newColumn) {
                        mappingLookup[m.newColumn] = {
                            convertType: m.convertType,
                            oldTable: m.oldTable ? m.oldTable.toLowerCase() : '',
                            oldColumn: m.oldColumn || '',
                            value: m.comments || '',
                            defaultValue: null,
                            useFkMapping: false
                        };
                    }
                });
            }

            // Then, override with loaded columnMappings if they exist
            Object.keys(columnMappings).forEach(colName => {
                const cm = columnMappings[colName];
                mappingLookup[colName] = {
                    convertType: cm.convertType,
                    oldTable: cm.oldTable ? cm.oldTable.toLowerCase() : '',
                    oldColumn: cm.oldColumn || '',
                    value: cm.value || '',
                    defaultValue: cm.defaultValue || null,
                    useFkMapping: cm.useFkMapping || false
                };
            });

            // Main project table - show only columns with mapping selectors
            if (data.newDB.table) {
                html += '<div class="table-card"><h3>Project Table - Field Mapping</h3>';

                data.newDB.table.columns.forEach(col => {
                    const mapping = mappingLookup[col.name];
                    const isConst = mapping && mapping.convertType === 'const';

                    html += `
                        <div class="column-row">
                            <div class="column-name">${col.name}: ${col.type}</div>
                            <div class="mapping-selectors">
                    `;

                    if (isConst) {
                        // For const type - show input field with value
                        html += `
                                <div class="const-label">Constant Value:</div>
                                <input type="text" id="value_${col.name}" value="${mapping.value}"
                                    onchange="onConstValueChanged('${col.name}', this.value)"
                                    placeholder="Enter constant value">
                        `;
                    } else {
                        // For direct type - show dropdowns
                        html += `
                                <select id="table_${col.name}" onchange="onTableSelected('${col.name}')">
                                    <option value="">-- Select Old Table --</option>
                                    ${allOldTables.map(table =>
                                        `<option value="${table}" ${mapping && mapping.oldTable === table ? 'selected' : ''}>${table}</option>`
                                    ).join('')}
                                </select>
                                <select id="column_${col.name}" ${mapping && mapping.oldTable ? '' : 'disabled'}>
                                    <option value="">-- Select Column --</option>
                                </select>
                        `;
                    }

                    // Add default value input for all columns
                    const defaultVal = mapping && mapping.defaultValue ? mapping.defaultValue : '';
                    html += `
                                <div class="default-value-input">
                                    <label>Default Value (if source is NULL):</label>
                                    <input type="text" id="default_${col.name}" value="${defaultVal}"
                                        onchange="onDefaultValueChanged('${col.name}', this.value)"
                                        placeholder="Optional - only used when source value is NULL">
                                </div>
                    `;

                    // Add FK mapping section for non-const fields
                    if (!isConst) {
                        const useFk = mapping && mapping.useFkMapping ? 'checked' : '';
                        const btnDisabled = mapping && mapping.useFkMapping ? '' : 'disabled';
                        html += `
                                <div class="fk-mapping-section">
                                    <label>
                                        <input type="checkbox" id="useFkMapping_${col.name}" ${useFk}
                                            onchange="onFkMappingToggle('${col.name}')">
                                        ×”×©×ª××© ×‘××™×¤×•×™ FK
                                    </label>
                                    <button class="fk-mapping-btn" id="fkMappingBtn_${col.name}"
                                        ${btnDisabled} onclick="openFkMappingModal('${col.name}')">
                                        ...
                                    </button>
                                </div>
                        `;
                    }

                    html += `
                            </div>
                        </div>
                    `;
                });

                html += '</div>';
            }

            container.innerHTML = html;

            // Load columns for pre-selected tables and store mappings
            for (const col of data.newDB.table.columns) {
                const mapping = mappingLookup[col.name];
                if (mapping) {
                    if (mapping.convertType === 'const') {
                        // Store const mapping
                        if (!columnMappings[col.name]) {
                            columnMappings[col.name] = {};
                        }
                        columnMappings[col.name].convertType = 'const';
                        columnMappings[col.name].value = mapping.value;
                        if (mapping.defaultValue) {
                            columnMappings[col.name].defaultValue = mapping.defaultValue;
                        }
                    } else if (mapping.oldTable && mapping.oldColumn) {
                        // Load dropdown for direct mappings and store in columnMappings
                        await loadColumnDropdown(col.name, mapping.oldTable, mapping.oldColumn);

                        // Ensure all loaded mapping data is in columnMappings
                        if (!columnMappings[col.name]) {
                            columnMappings[col.name] = {};
                        }
                        if (mapping.defaultValue) {
                            columnMappings[col.name].defaultValue = mapping.defaultValue;
                        }
                        if (mapping.useFkMapping) {
                            columnMappings[col.name].useFkMapping = mapping.useFkMapping;
                        }
                    }
                }
            }
        }

        async function loadColumnDropdown(projectColumn, selectedTable, preselectedColumn = null) {
            const columnSelect = document.getElementById(`column_${projectColumn}`);

            // Load table data if not cached
            if (!oldTablesData[selectedTable]) {
                try {
                    const response = await fetch(`/api/old-table/${selectedTable}`);
                    oldTablesData[selectedTable] = await response.json();
                } catch (error) {
                    console.error('Error loading table:', error);
                    return;
                }
            }

            // Populate column dropdown
            const tableData = oldTablesData[selectedTable];
            columnSelect.disabled = false;
            columnSelect.innerHTML = '<option value="">-- Select Column --</option>' +
                tableData.columns.map(col =>
                    `<option value="${col.name}" ${preselectedColumn === col.name ? 'selected' : ''}>${col.name}: ${col.type}</option>`
                ).join('');

            // Store mapping
            if (preselectedColumn) {
                if (!columnMappings[projectColumn]) {
                    columnMappings[projectColumn] = {};
                }
                columnMappings[projectColumn].convertType = 'direct';
                columnMappings[projectColumn].oldTable = selectedTable;
                columnMappings[projectColumn].oldColumn = preselectedColumn;
            }

            // Set up onchange handler
            columnSelect.onchange = () => {
                if (columnSelect.value) {
                    if (!columnMappings[projectColumn]) {
                        columnMappings[projectColumn] = {};
                    }
                    // Preserve defaultValue if it exists
                    const existingDefault = columnMappings[projectColumn].defaultValue;
                    columnMappings[projectColumn].convertType = 'direct';
                    columnMappings[projectColumn].oldTable = selectedTable;
                    columnMappings[projectColumn].oldColumn = columnSelect.value;
                    if (existingDefault) {
                        columnMappings[projectColumn].defaultValue = existingDefault;
                    }
                    console.log('Current mappings:', columnMappings);
                }
            };
        }

        async function onTableSelected(projectColumn) {
            const tableSelect = document.getElementById(`table_${projectColumn}`);
            const columnSelect = document.getElementById(`column_${projectColumn}`);
            const selectedTable = tableSelect.value;

            if (!selectedTable) {
                columnSelect.disabled = true;
                columnSelect.innerHTML = '<option value="">-- Select Column --</option>';
                return;
            }

            await loadColumnDropdown(projectColumn, selectedTable);
        }

        function onConstValueChanged(projectColumn, value) {
            if (!columnMappings[projectColumn]) {
                columnMappings[projectColumn] = {};
            }
            columnMappings[projectColumn].convertType = 'const';
            columnMappings[projectColumn].value = value;
            console.log('Current mappings:', columnMappings);
        }

        function onDefaultValueChanged(projectColumn, value) {
            if (!columnMappings[projectColumn]) {
                columnMappings[projectColumn] = {};
            }
            columnMappings[projectColumn].defaultValue = value || null;
            console.log('Current mappings:', columnMappings);
        }

        // FK Mapping functions
        function onFkMappingToggle(columnName) {
            const checkbox = document.getElementById(`useFkMapping_${columnName}`);
            const button = document.getElementById(`fkMappingBtn_${columnName}`);
            button.disabled = !checkbox.checked;

            // Store FK mapping enabled state
            if (!columnMappings[columnName]) {
                columnMappings[columnName] = {};
            }
            columnMappings[columnName].useFkMapping = checkbox.checked;
        }

        function openFkMappingModal(columnName) {
            currentFkColumn = columnName;
            document.getElementById('fkModalColumnName').textContent = columnName;
            document.getElementById('fkMappingModal').classList.add('active');

            // Populate source table dropdown
            const select = document.getElementById('fkSourceTable');
            select.innerHTML = '<option value="">-- Select Table --</option>' +
                allOldTables.map(table => `<option value="${table}">${table}</option>`).join('');

            // Load existing FK mapping if available
            loadExistingFkMapping(columnName);
        }

        function closeFkMappingModal() {
            document.getElementById('fkMappingModal').classList.remove('active');
            document.getElementById('fkTableDataContainer').style.display = 'none';
            document.getElementById('fkSourceTable').value = '';
            currentFkColumn = null;
        }

        async function onFkSourceTableChange() {
            const tableName = document.getElementById('fkSourceTable').value;
            const keyColumnSelect = document.getElementById('fkKeyColumn');
            const keyColumnGroup = document.getElementById('fkKeyColumnGroup');

            if (!tableName) {
                keyColumnGroup.style.display = 'none';
                document.getElementById('fkTableDataContainer').style.display = 'none';
                return;
            }

            try {
                // Load table structure to get columns
                const response = await fetch(`/api/old-table/${tableName}`);
                const tableData = await response.json();

                // Populate key column dropdown
                keyColumnSelect.innerHTML = '<option value="">-- Select Column --</option>' +
                    tableData.columns.map(col => `<option value="${col.name}">${col.name}: ${col.type}</option>`).join('');

                keyColumnGroup.style.display = 'block';
                document.getElementById('fkTableDataContainer').style.display = 'none';
            } catch (error) {
                alert('×©×’×™××” ×‘×˜×¢×™× ×ª ×¢××•×“×•×ª: ' + error.message);
            }
        }

        async function loadExistingFkMapping(columnName) {
            try {
                const response = await fetch(`/api/fk-mapping/${columnName}`);
                const result = await response.json();

                if (result.success && result.exists) {
                    const mapping = result.mapping;
                    document.getElementById('fkSourceTable').value = mapping.sourceTable;

                    // Load columns for the table first
                    await onFkSourceTableChange();

                    // Set the key column if it exists
                    if (mapping.keyColumn) {
                        document.getElementById('fkKeyColumn').value = mapping.keyColumn;
                    }

                    fkMappings[columnName] = mapping.mappings;
                    await loadFkTableData();
                }
            } catch (error) {
                console.error('Error loading FK mapping:', error);
            }
        }

        async function loadFkTableData() {
            const tableName = document.getElementById('fkSourceTable').value;
            if (!tableName) {
                document.getElementById('fkTableDataContainer').style.display = 'none';
                return;
            }

            try {
                const response = await fetch('/api/table-data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tableName })
                });

                const result = await response.json();
                if (!result.success) {
                    alert('×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™×: ' + result.message);
                    return;
                }

                fkTableData = result.data;
                renderFkTable(result.data);
                document.getElementById('fkTableDataContainer').style.display = 'block';
            } catch (error) {
                alert('×©×’×™××”: ' + error.message);
            }
        }

        function renderFkTable(data) {
            if (!data || data.length === 0) {
                document.getElementById('fkTableDataContainer').style.display = 'none';
                return;
            }

            const thead = document.getElementById('fkTableHead');
            const tbody = document.getElementById('fkTableBody');
            const keyColumn = document.getElementById('fkKeyColumn').value;

            // Get columns from first row
            const columns = Object.keys(data[0]);

            // Render header
            let headerHtml = '<tr>';
            columns.forEach(col => {
                headerHtml += `<th>${col}</th>`;
            });
            headerHtml += '<th>×¢×¨×š ×—×“×©</th></tr>';
            thead.innerHTML = headerHtml;

            // Render body
            let bodyHtml = '';
            data.forEach((row, idx) => {
                bodyHtml += '<tr>';
                columns.forEach(col => {
                    bodyHtml += `<td>${row[col] !== null ? row[col] : '(NULL)'}</td>`;
                });

                // Get existing mapping value using the key column value
                const keyValue = row[keyColumn];
                const existingValue = fkMappings[currentFkColumn]?.[keyValue] || '';
                bodyHtml += `<td><input type="text" id="fkMap_${idx}" value="${existingValue}" placeholder="×”×›× ×¡ ×¢×¨×š ×—×“×©"></td>`;
                bodyHtml += '</tr>';
            });
            tbody.innerHTML = bodyHtml;
        }

        async function saveFkMapping() {
            const tableName = document.getElementById('fkSourceTable').value;
            const keyColumn = document.getElementById('fkKeyColumn').value;

            if (!tableName) {
                alert('× × ×œ×‘×—×•×¨ ×˜×‘×œ×”');
                return;
            }

            if (!keyColumn) {
                alert('× × ×œ×‘×—×•×¨ ×©×“×” ××–×”×”');
                return;
            }

            // Collect mappings - use key column value as the mapping key
            const mappings = {};
            fkTableData.forEach((row, idx) => {
                const newValue = document.getElementById(`fkMap_${idx}`)?.value;
                if (newValue) {
                    const keyValue = row[keyColumn];
                    mappings[keyValue] = newValue;
                }
            });

            try {
                const response = await fetch(`/api/fk-mapping/${currentFkColumn}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sourceTable: tableName,
                        keyColumn: keyColumn,
                        mappings: mappings
                    })
                });

                const result = await response.json();
                if (result.success) {
                    alert('âœ“ ××™×¤×•×™ × ×©××¨ ×‘×”×¦×œ×—×”!');
                    fkMappings[currentFkColumn] = mappings;
                    closeFkMappingModal();
                } else {
                    alert('âœ— ×©×’×™××” ×‘×©××™×¨×”: ' + result.message);
                }
            } catch (error) {
                alert('âœ— ×©×’×™××”: ' + error.message);
            }
        }

        // Clear logs function
        async function clearLogs() {
            if (!confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ×¨×•×§×Ÿ ××ª ×§×•×‘×¥ ×”×œ×•×’? ×¤×¢×•×œ×” ×–×• ×‘×œ×ª×™ ×”×¤×™×›×”.')) {
                return;
            }

            try {
                const response = await fetch('/api/clear-logs', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const result = await response.json();

                if (result.success) {
                    alert('âœ“ ×§×•×‘×¥ ×”×œ×•×’ ×¨×•×§×Ÿ ×‘×”×¦×œ×—×”!');
                } else {
                    alert('âœ— ×©×’×™××”: ' + result.message);
                }
            } catch (error) {
                alert('âœ— ×©×’×™××”: ' + error.message);
            }
        }

        // Load data on page load
        loadData();

        // Modal functions
        function openConnectionModal() {
            document.getElementById('connectionModal').classList.add('active');
            loadSavedConnections();
        }

        function closeConnectionModal() {
            document.getElementById('connectionModal').classList.remove('active');
        }

        // Save connection details to localStorage
        function saveConnectionDetails() {
            const connections = {
                mssql: {
                    server: document.getElementById('mssqlServer').value,
                    database: document.getElementById('mssqlDatabase').value,
                    user: document.getElementById('mssqlUser').value,
                    password: document.getElementById('mssqlPassword').value
                },
                mysql: {
                    host: document.getElementById('mysqlHost').value,
                    database: document.getElementById('mysqlDatabase').value,
                    user: document.getElementById('mysqlUser').value,
                    password: document.getElementById('mysqlPassword').value
                }
            };
            localStorage.setItem('dbConnections', JSON.stringify(connections));
        }

        // Load saved connection details from localStorage
        function loadSavedConnections() {
            const saved = localStorage.getItem('dbConnections');
            if (saved) {
                try {
                    const connections = JSON.parse(saved);

                    // Load MSSQL
                    if (connections.mssql) {
                        document.getElementById('mssqlServer').value = connections.mssql.server || '';
                        document.getElementById('mssqlDatabase').value = connections.mssql.database || '';
                        document.getElementById('mssqlUser').value = connections.mssql.user || '';
                        document.getElementById('mssqlPassword').value = connections.mssql.password || '';
                    }

                    // Load MySQL
                    if (connections.mysql) {
                        document.getElementById('mysqlHost').value = connections.mysql.host || '';
                        document.getElementById('mysqlDatabase').value = connections.mysql.database || '';
                        document.getElementById('mysqlUser').value = connections.mysql.user || '';
                        document.getElementById('mysqlPassword').value = connections.mysql.password || '';
                    }
                } catch (e) {
                    console.error('Error loading saved connections:', e);
                }
            }
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('connectionModal');
            if (event.target === modal) {
                closeConnectionModal();
            }
        }

        // Test MSSQL Connection
        async function testMSSQLConnection() {
            const statusDiv = document.getElementById('mssqlStatus');
            statusDiv.innerHTML = '<div class="status-message">×‘×•×“×§ ×—×™×‘×•×¨...</div>';

            const config = {
                server: document.getElementById('mssqlServer').value,
                database: document.getElementById('mssqlDatabase').value,
                user: document.getElementById('mssqlUser').value,
                password: document.getElementById('mssqlPassword').value
            };

            try {
                const response = await fetch('/api/test-mssql', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });

                const result = await response.json();

                if (result.success) {
                    statusDiv.innerHTML = `<div class="status-message success">${result.message}</div>`;
                    saveConnectionDetails(); // Save on successful connection
                } else {
                    statusDiv.innerHTML = `<div class="status-message error">${result.message}</div>`;
                }
            } catch (error) {
                statusDiv.innerHTML = `<div class="status-message error">×©×’×™××”: ${error.message}</div>`;
            }
        }

        // Test MySQL Connection
        async function testMySQLConnection() {
            const statusDiv = document.getElementById('mysqlStatus');
            statusDiv.innerHTML = '<div class="status-message">×‘×•×“×§ ×—×™×‘×•×¨...</div>';

            const config = {
                host: document.getElementById('mysqlHost').value,
                database: document.getElementById('mysqlDatabase').value,
                user: document.getElementById('mysqlUser').value,
                password: document.getElementById('mysqlPassword').value
            };

            try {
                const response = await fetch('/api/test-mysql', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });

                const result = await response.json();

                if (result.success) {
                    statusDiv.innerHTML = `<div class="status-message success">${result.message}</div>`;
                    saveConnectionDetails(); // Save on successful connection
                } else {
                    statusDiv.innerHTML = `<div class="status-message error">${result.message}</div>`;
                }
            } catch (error) {
                statusDiv.innerHTML = `<div class="status-message error">×©×’×™××”: ${error.message}</div>`;
            }
        }

        // Execute Migration
        async function executeMigration() {
            const statusDiv = document.getElementById('migrationStatus');

            if (Object.keys(columnMappings).length === 0) {
                statusDiv.innerHTML = '<div class="status-message error">×œ× × ××¦× ××™×¤×•×™. ×× × ×”×’×“×¨ ××™×¤×•×™ ×ª×—×™×œ×” ×‘××¡×š ×”×¨××©×™.</div>';
                return;
            }

            console.log('Sending mappings:', columnMappings);
            console.log('Sending localization mappings:', localizationMappings);
            console.log('Sending projectItem mappings:', projectItemMappings);
            console.log('Sending WHERE clause:', whereClause);
            statusDiv.innerHTML = '<div class="status-message">××ª×—×™×œ ××™×’×¨×¦×™×”... ×× × ×”××ª×Ÿ</div>';

            try {
                const response = await fetch('/api/migrate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        tableName: 'project',
                        mappings: columnMappings,
                        localizationMappings: localizationMappings,
                        projectItemMappings: projectItemMappings,
                        whereClause: whereClause
                    })
                });

                const result = await response.json();

                if (result.success) {
                    let resultHtml = `<div class="status-message success">${result.message}<br><br>`;

                    // Project table results
                    if (result.project) {
                        resultHtml += `<strong>×˜×‘×œ×ª Project:</strong> ${result.project.insertedCount} ××ª×•×š ${result.project.totalRows} ×¨×©×•××•×ª<br>`;

                        if (result.project.errors && result.project.errors.length > 0) {
                            resultHtml += `<br><strong>×©×’×™××•×ª Project (${result.project.errors.length} ×¨××©×•× ×•×ª):</strong><br>`;
                            result.project.errors.forEach(err => {
                                resultHtml += `- [Row ID: ${err.rowId}] ${err.error}<br>`;
                            });
                        }
                    }

                    // Localization results
                    if (result.projectLocalization) {
                        resultHtml += `<br><strong>×˜×‘×œ×ª projectLocalization:</strong> ${result.projectLocalization.insertedCount} ××ª×•×š ${result.projectLocalization.totalRows} ×¨×©×•××•×ª<br>`;

                        if (result.projectLocalization.errors && result.projectLocalization.errors.length > 0) {
                            resultHtml += `<br><strong>×©×’×™××•×ª Localization (${result.projectLocalization.errors.length} ×¨××©×•× ×•×ª):</strong><br>`;
                            result.projectLocalization.errors.forEach(err => {
                                resultHtml += `- [Project ID: ${err.projectId}, Lang: ${err.language}] ${err.error}<br>`;
                            });
                        }
                    }

                    // ProjectItem results
                    if (result.projectItem) {
                        resultHtml += `<br><strong>×˜×‘×œ×ª projectItem:</strong> ${result.projectItem.insertedCount} ×¤×¨×™×˜×™× × ×•×¦×¨×•<br>`;

                        if (result.projectItem.errors && result.projectItem.errors.length > 0) {
                            resultHtml += `<br><strong>×©×’×™××•×ª ProjectItem (${result.projectItem.errors.length} ×¨××©×•× ×•×ª):</strong><br>`;
                            result.projectItem.errors.forEach(err => {
                                resultHtml += `- [Project ID: ${err.newProjectId}] ${err.error}<br>`;
                            });
                        }
                    }

                    resultHtml += '</div>';
                    statusDiv.innerHTML = resultHtml;
                } else {
                    statusDiv.innerHTML = `<div class="status-message error">${result.message}</div>`;
                }
            } catch (error) {
                statusDiv.innerHTML = `<div class="status-message error">×©×’×™××”: ${error.message}</div>`;
            }
        }

        // ===== Mapping Save/Load Functions =====

        function openSaveMappingModal() {
            document.getElementById('mappingFilename').value = '';
            document.getElementById('saveMappingModal').classList.add('active');
        }

        function closeSaveMappingModal() {
            document.getElementById('saveMappingModal').classList.remove('active');
        }

        async function saveCurrentMapping() {
            const filename = document.getElementById('mappingFilename').value.trim();

            if (!filename) {
                alert('× × ×œ×”×–×™×Ÿ ×©× ×œ×§×•×‘×¥ ×”××™×¤×•×™');
                return;
            }

            if (Object.keys(columnMappings).length === 0) {
                alert('××™×Ÿ ××™×¤×•×™ ×œ×©××•×¨. ×× × ×”×’×“×¨ ××™×¤×•×™ ×ª×—×™×œ×”.');
                return;
            }

            try {
                const response = await fetch('/api/save-mapping', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        filename: filename,
                        columnMappings: columnMappings,
                        fkMappings: fkMappings,
                        localizationMappings: localizationMappings,
                        projectItemMappings: projectItemMappings,
                        whereClause: whereClause
                    })
                });

                const result = await response.json();

                if (result.success) {
                    alert(`âœ“ ×”××™×¤×•×™ × ×©××¨ ×‘×”×¦×œ×—×”!\n×©× ×§×•×‘×¥: ${result.filename}.json`);
                    closeSaveMappingModal();
                } else {
                    alert('âœ— ×©×’×™××” ×‘×©××™×¨×”: ' + result.message);
                }
            } catch (error) {
                alert('âœ— ×©×’×™××”: ' + error.message);
            }
        }

        async function openLoadMappingModal() {
            document.getElementById('loadMappingModal').classList.add('active');
            await loadMappingFilesList();
        }

        function closeLoadMappingModal() {
            document.getElementById('loadMappingModal').classList.remove('active');
        }

        async function loadMappingFilesList() {
            const listDiv = document.getElementById('mappingFilesList');
            listDiv.innerHTML = '<p style="text-align: center; color: #6c757d;">×˜×•×¢×Ÿ ×¨×©×™××ª ×§×‘×¦×™×...</p>';

            try {
                const response = await fetch('/api/mappings');
                const result = await response.json();

                if (!result.success) {
                    listDiv.innerHTML = '<p style="text-align: center; color: #dc3545;">×©×’×™××” ×‘×˜×¢×™× ×ª ×”×¨×©×™××”</p>';
                    return;
                }

                if (result.mappings.length === 0) {
                    listDiv.innerHTML = '<p style="text-align: center; color: #6c757d;">××™×Ÿ ×§×‘×¦×™ ××™×¤×•×™ ×©××•×¨×™×</p>';
                    return;
                }

                let html = '<div style="display: flex; flex-direction: column; gap: 10px;">';
                result.mappings.forEach(mapping => {
                    const date = new Date(mapping.savedAt).toLocaleString('he-IL');
                    const sizeKB = (mapping.size / 1024).toFixed(2);
                    html += `
                        <div style="border: 1px solid #dee2e6; border-radius: 8px; padding: 15px; cursor: pointer; transition: all 0.2s;"
                             onmouseover="this.style.borderColor='#667eea'; this.style.background='#f8f9fa';"
                             onmouseout="this.style.borderColor='#dee2e6'; this.style.background='white';"
                             onclick="loadMappingFromFile('${mapping.filename}')">
                            <div style="font-weight: bold; font-size: 16px; margin-bottom: 5px;">${mapping.filename}</div>
                            <div style="font-size: 13px; color: #6c757d;">
                                × ×©××¨: ${date} | ×’×•×“×œ: ${sizeKB} KB
                            </div>
                        </div>
                    `;
                });
                html += '</div>';

                listDiv.innerHTML = html;
            } catch (error) {
                listDiv.innerHTML = '<p style="text-align: center; color: #dc3545;">×©×’×™××”: ' + error.message + '</p>';
            }
        }

        async function loadMappingFromFile(filename) {
            if (!confirm(`×”×× ×œ×˜×¢×•×Ÿ ××ª ×”××™×¤×•×™ "${filename}"?\n×”××™×¤×•×™ ×”× ×•×›×—×™ ×™×•×—×œ×£.`)) {
                return;
            }

            try {
                const response = await fetch(`/api/load-mapping/${filename}`);
                const result = await response.json();

                if (!result.success) {
                    alert('âœ— ×©×’×™××” ×‘×˜×¢×™× ×”: ' + result.message);
                    return;
                }

                // Load column mappings
                columnMappings = result.mapping.columnMappings || {};
                fkMappings = result.mapping.fkMappings || {};
                localizationMappings = result.mapping.localizationMappings || {};
                projectItemMappings = result.mapping.projectItemMappings || {};
                whereClause = result.mapping.whereClause || null;

                // Refresh the UI to reflect loaded mappings
                await loadData();

                // If localization mappings exist, load and render them
                if (Object.keys(localizationMappings).length > 0 && !localizationData) {
                    await loadLocalizationData();
                } else if (localizationData) {
                    renderLocalizationFields();
                }

                // If projectItem mappings exist, load and render them
                if (Object.keys(projectItemMappings).length > 0 && !projectItemData) {
                    await loadProjectItemData();
                } else if (projectItemData) {
                    renderProjectItemFields();
                }

                closeLoadMappingModal();
                const locCount = Object.keys(localizationMappings).length;
                const itemCount = Object.keys(projectItemMappings).length;
                alert(`âœ“ ×”××™×¤×•×™ × ×˜×¢×Ÿ ×‘×”×¦×œ×—×”!\n× ×˜×¢× ×• ${Object.keys(columnMappings).length} ××™×¤×•×™×™ ×©×“×•×ª Project${locCount > 0 ? ` + ${locCount} ×©×“×•×ª Localization` : ''}${itemCount > 0 ? ` + ProjectItem mappings` : ''}`);
            } catch (error) {
                alert('âœ— ×©×’×™××”: ' + error.message);
            }
        }

        // ===== Localization Accordion & Tabs Functions =====

        function toggleLocalizationAccordion() {
            const content = document.getElementById('localizationContent');
            const icon = document.getElementById('localizationToggleIcon');

            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.textContent = 'â–²';

                // Load localization data if not loaded yet
                if (!localizationData) {
                    loadLocalizationData();
                }
            } else {
                content.style.display = 'none';
                icon.textContent = 'â–¼';
            }
        }

        function toggleProjectItemAccordion() {
            const content = document.getElementById('projectItemContent');
            const icon = document.getElementById('projectItemToggleIcon');

            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.textContent = 'â–²';

                // Load projectItem data if not loaded yet
                if (!projectItemData) {
                    loadProjectItemData();
                }
            } else {
                content.style.display = 'none';
                icon.textContent = 'â–¼';
            }
        }

        function switchLanguageTab(language) {
            // Update current language
            currentLanguage = language;

            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });

            // Remove active from all buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(`${language}Tab`).classList.add('active');

            // Activate selected button
            event.target.classList.add('active');
        }

        async function loadLocalizationData() {
            try {
                const response = await fetch('/api/analyze/projectlocalization');
                localizationData = await response.json();

                // Load default mappings from CSV for Hebrew (Step=1) if no mappings exist
                if (Object.keys(localizationMappings).length === 0 && localizationData.mappings) {
                    const hebrewMappings = localizationData.mappings.filter(m => m.step === '1');

                    hebrewMappings.forEach(mapping => {
                        if (!mapping.newColumn || !mapping.convertType) return;

                        const fieldName = mapping.newColumn;

                        // Only load direct and const mappings
                        if (mapping.convertType === 'direct' && mapping.oldTable && mapping.oldColumn) {
                            if (!localizationMappings[fieldName]) {
                                localizationMappings[fieldName] = {};
                            }
                            localizationMappings[fieldName].hebrew = {
                                convertType: 'direct',
                                oldTable: mapping.oldTable.toLowerCase(),
                                oldColumn: mapping.oldColumn
                            };
                        } else if (mapping.convertType === 'const' && mapping.comments) {
                            // Extract const value from comments
                            if (!localizationMappings[fieldName]) {
                                localizationMappings[fieldName] = {};
                            }
                            localizationMappings[fieldName].hebrew = {
                                convertType: 'const',
                                value: mapping.comments
                            };
                        }
                    });

                    console.log('Loaded default Hebrew mappings from CSV:', localizationMappings);
                }

                // Render fields for all languages
                renderLocalizationFields();
            } catch (error) {
                console.error('Error loading localization data:', error);
                alert('×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™ localization: ' + error.message);
            }
        }

        function renderLocalizationFields() {
            if (!localizationData || !localizationData.newDB || !localizationData.newDB.table) {
                return;
            }

            const columns = localizationData.newDB.table.columns;

            // Fields to skip (auto-populated)
            const skipFields = ['id', 'projectid', 'language'];

            // Render for each language
            ['hebrew', 'english', 'french'].forEach(lang => {
                const container = document.getElementById(`${lang}Fields`);
                let html = '';

                columns.forEach(col => {
                    if (skipFields.includes(col.name.toLowerCase())) {
                        return;  // Skip this field
                    }

                    // Get existing mapping if any
                    const mapping = localizationMappings[col.name]?.[lang] || {};

                    html += `
                        <div class="column-row">
                            <div class="column-name">${col.name}: ${col.type}</div>
                            <div class="mapping-selectors">
                                <select id="loc_${lang}_table_${col.name}" onchange="onLocalizationTableSelected('${lang}', '${col.name}')">
                                    <option value="">-- Select Old Table --</option>
                                    ${allOldTables.map(table =>
                                        `<option value="${table}" ${mapping.oldTable === table ? 'selected' : ''}>${table}</option>`
                                    ).join('')}
                                </select>
                                <select id="loc_${lang}_column_${col.name}" ${mapping.oldTable ? '' : 'disabled'}>
                                    <option value="">-- Select Column --</option>
                                </select>

                                <div class="default-value-input">
                                    <label>Default Value (if source is NULL):</label>
                                    <input type="text" id="loc_${lang}_default_${col.name}" value="${mapping.defaultValue || ''}"
                                        onchange="onLocalizationDefaultChanged('${lang}', '${col.name}', this.value)"
                                        placeholder="Optional">
                                </div>

                                <div class="fk-mapping-section">
                                    <label>
                                        <input type="checkbox" id="loc_${lang}_useFk_${col.name}" ${mapping.useFkMapping ? 'checked' : ''}
                                            onchange="onLocalizationFkToggle('${lang}', '${col.name}')">
                                        ×”×©×ª××© ×‘××™×¤×•×™ FK
                                    </label>
                                    <button class="fk-mapping-btn" id="loc_${lang}_fkBtn_${col.name}"
                                        ${mapping.useFkMapping ? '' : 'disabled'} onclick="openLocalizationFkMapping('${lang}', '${col.name}')">
                                        ...
                                    </button>
                                </div>

                                <div class="expression-input">
                                    <label>JavaScript Expression (optional):</label>
                                    <textarea id="loc_${lang}_expression_${col.name}"
                                        onchange="onLocalizationExpressionChanged('${lang}', '${col.name}', this.value)"
                                        placeholder="e.g., value ? value.substring(0, 150) : null&#10;&#10;Available variables:&#10;  value = source column value&#10;  row = entire source row"
                                        rows="3">${mapping.expression || ''}</textarea>
                                    <small style="color: #6c757d;">
                                        Examples:
                                        <a href="#" onclick="setExampleExpression('${lang}', '${col.name}', 'truncate'); return false;">Truncate 150</a> |
                                        <a href="#" onclick="setExampleExpression('${lang}', '${col.name}', 'invert'); return false;">Invert Boolean</a> |
                                        <a href="#" onclick="setExampleExpression('${lang}', '${col.name}', 'nullIfZero'); return false;">NULL if zero</a>
                                    </small>
                                </div>
                            </div>
                        </div>
                    `;
                });

                container.innerHTML = html;

                // Load existing column selections
                columns.forEach(col => {
                    if (skipFields.includes(col.name.toLowerCase())) {
                        return;
                    }

                    const mapping = localizationMappings[col.name]?.[lang];
                    if (mapping && mapping.oldTable && mapping.oldColumn) {
                        loadLocalizationColumnDropdown(lang, col.name, mapping.oldTable, mapping.oldColumn);
                    }
                });
            });
        }

        async function onLocalizationTableSelected(language, fieldName) {
            const tableSelect = document.getElementById(`loc_${language}_table_${fieldName}`);
            const columnSelect = document.getElementById(`loc_${language}_column_${fieldName}`);
            const selectedTable = tableSelect.value;

            if (!selectedTable) {
                columnSelect.disabled = true;
                columnSelect.innerHTML = '<option value="">-- Select Column --</option>';
                return;
            }

            await loadLocalizationColumnDropdown(language, fieldName, selectedTable);
        }

        async function loadLocalizationColumnDropdown(language, fieldName, selectedTable, preselectedColumn = null) {
            const columnSelect = document.getElementById(`loc_${language}_column_${fieldName}`);

            // Load table data if not cached
            if (!oldTablesData[selectedTable]) {
                try {
                    const response = await fetch(`/api/old-table/${selectedTable}`);
                    oldTablesData[selectedTable] = await response.json();
                } catch (error) {
                    console.error('Error loading table:', error);
                    return;
                }
            }

            // Populate column dropdown
            const tableData = oldTablesData[selectedTable];
            columnSelect.disabled = false;
            columnSelect.innerHTML = '<option value="">-- Select Column --</option>' +
                tableData.columns.map(col =>
                    `<option value="${col.name}" ${preselectedColumn === col.name ? 'selected' : ''}>${col.name}: ${col.type}</option>`
                ).join('');

            // Set up onchange handler
            columnSelect.onchange = () => {
                if (columnSelect.value) {
                    if (!localizationMappings[fieldName]) {
                        localizationMappings[fieldName] = {};
                    }
                    if (!localizationMappings[fieldName][language]) {
                        localizationMappings[fieldName][language] = {};
                    }

                    localizationMappings[fieldName][language].convertType = 'direct';
                    localizationMappings[fieldName][language].oldTable = selectedTable;
                    localizationMappings[fieldName][language].oldColumn = columnSelect.value;

                    console.log('Localization mappings:', localizationMappings);
                }
            };

            // If preselected, trigger the mapping
            if (preselectedColumn) {
                if (!localizationMappings[fieldName]) {
                    localizationMappings[fieldName] = {};
                }
                if (!localizationMappings[fieldName][language]) {
                    localizationMappings[fieldName][language] = {};
                }

                localizationMappings[fieldName][language].convertType = 'direct';
                localizationMappings[fieldName][language].oldTable = selectedTable;
                localizationMappings[fieldName][language].oldColumn = preselectedColumn;
            }
        }

        function onLocalizationDefaultChanged(language, fieldName, value) {
            if (!localizationMappings[fieldName]) {
                localizationMappings[fieldName] = {};
            }
            if (!localizationMappings[fieldName][language]) {
                localizationMappings[fieldName][language] = {};
            }
            localizationMappings[fieldName][language].defaultValue = value || null;
            console.log('Localization mappings:', localizationMappings);
        }

        function onLocalizationFkToggle(language, fieldName) {
            const checkbox = document.getElementById(`loc_${language}_useFk_${fieldName}`);
            const button = document.getElementById(`loc_${language}_fkBtn_${fieldName}`);
            button.disabled = !checkbox.checked;

            if (!localizationMappings[fieldName]) {
                localizationMappings[fieldName] = {};
            }
            if (!localizationMappings[fieldName][language]) {
                localizationMappings[fieldName][language] = {};
            }
            localizationMappings[fieldName][language].useFkMapping = checkbox.checked;
        }

        function openLocalizationFkMapping(language, fieldName) {
            // For now, reuse the existing FK mapping modal
            // In future, could create a separate modal for localization FK mappings
            alert(`FK mapping for ${fieldName} (${language}) - ×ª×›×•× ×” ×ª×”×™×” ×–××™× ×” ×‘×§×¨×•×‘`);
        }

        function onLocalizationExpressionChanged(lang, fieldName, value) {
            if (!localizationMappings[fieldName]) {
                localizationMappings[fieldName] = {};
            }
            if (!localizationMappings[fieldName][lang]) {
                localizationMappings[fieldName][lang] = {};
            }

            // Store the expression (trim whitespace)
            const expression = value.trim();
            if (expression) {
                localizationMappings[fieldName][lang].expression = expression;
            } else {
                delete localizationMappings[fieldName][lang].expression;
            }

            console.log(`Expression updated for ${fieldName} (${lang}):`, expression);
        }

        function setExampleExpression(lang, fieldName, type) {
            const textarea = document.getElementById(`loc_${lang}_expression_${fieldName}`);
            if (!textarea) return;

            let exampleCode = '';

            switch(type) {
                case 'truncate':
                    exampleCode = 'value ? value.substring(0, 150) : null';
                    break;
                case 'invert':
                    exampleCode = 'value ? 0 : 1';
                    break;
                case 'nullIfZero':
                    exampleCode = 'value === 0 ? null : value';
                    break;
                case 'stringReplace':
                    exampleCode = 'value ? value.replace(/old/g, "new") : null';
                    break;
                default:
                    exampleCode = '';
            }

            textarea.value = exampleCode;

            // Trigger the change event to save it
            onLocalizationExpressionChanged(lang, fieldName, exampleCode);
        }

        // ===== ProjectItem Functions =====

        async function loadProjectItemData() {
            try {
                const response = await fetch('/api/analyze/projectitem');
                projectItemData = await response.json();

                // Load existing projectItemMappings structure if it doesn't exist
                if (Object.keys(projectItemMappings).length === 0) {
                    // Initialize structure
                    projectItemMappings = {
                        funds: {},
                        collections: {
                            certificate: {},
                            donation: {}
                        }
                    };
                }

                // Render fields for all item types
                renderProjectItemFields();
            } catch (error) {
                console.error('Error loading projectItem data:', error);
                alert('×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™ projectItem: ' + error.message);
            }
        }

        function renderProjectItemFields() {
            if (!projectItemData || !projectItemData.newDB || !projectItemData.newDB.table) {
                return;
            }

            const container = document.getElementById('projectItemFields');
            const columns = projectItemData.newDB.table.columns;

            // Fields to skip (auto-populated)
            const skipFields = ['id', 'projectid'];

            let html = '';

            columns.forEach(col => {
                if (skipFields.includes(col.name.toLowerCase())) {
                    return;  // Skip this field
                }

                // Get existing mapping - support both old and new structure
                // Try new flat structure first, then fall back to old hierarchical structure
                let mapping = projectItemMappings.fields?.[col.name];
                if (!mapping) {
                    // Try to find in old structure (funds or collections)
                    mapping = projectItemMappings.funds?.[col.name] ||
                             projectItemMappings.collections?.certificate?.[col.name] ||
                             projectItemMappings.collections?.donation?.[col.name] || {};
                }

                html += `
                    <div class="column-row">
                        <div class="column-name">${col.name}: ${col.type}</div>
                        <div class="mapping-selectors">
                            ${mapping.convertType === 'const' ? `
                                <div class="const-label">Constant Value:</div>
                                <input type="text" id="item_value_${col.name}" value="${mapping.value || ''}"
                                    onchange="onProjectItemConstChanged('${col.name}', this.value)"
                                    placeholder="Enter constant value">
                            ` : `
                                <select id="item_table_${col.name}" onchange="onProjectItemTableSelected('${col.name}')">
                                    <option value="">-- Select Old Table --</option>
                                    ${allOldTables.map(table =>
                                        `<option value="${table}" ${mapping.oldTable === table ? 'selected' : ''}>${table}</option>`
                                    ).join('')}
                                </select>
                                <select id="item_column_${col.name}" ${mapping.oldTable ? '' : 'disabled'}>
                                    <option value="">-- Select Column --</option>
                                </select>
                            `}

                            <div class="default-value-input">
                                <label>Default Value (if source is NULL):</label>
                                <input type="text" id="item_default_${col.name}" value="${mapping.defaultValue || ''}"
                                    onchange="onProjectItemDefaultChanged('${col.name}', this.value)"
                                    placeholder="Optional">
                            </div>

                            <div class="expression-input">
                                <label>JavaScript Expression (optional):</label>
                                <textarea id="item_expression_${col.name}"
                                    onchange="onProjectItemExpressionChanged('${col.name}', this.value)"
                                    placeholder="e.g., value ? value.substring(0, 150) : null&#10;&#10;Available variables:&#10;  value = source column value&#10;  row = entire source row"
                                    rows="3">${mapping.expression || ''}</textarea>
                                <small style="color: #6c757d;">
                                    Examples:
                                    <a href="#" onclick="setItemExampleExpression('${col.name}', 'truncate'); return false;">Truncate 150</a> |
                                    <a href="#" onclick="setItemExampleExpression('${col.name}', 'nullIfZero'); return false;">NULL if zero</a>
                                </small>
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;

            // Load existing column selections
            columns.forEach(col => {
                if (skipFields.includes(col.name.toLowerCase())) {
                    return;
                }

                // Try new flat structure first, then fall back to old hierarchical structure
                let mapping = projectItemMappings.fields?.[col.name];
                if (!mapping) {
                    mapping = projectItemMappings.funds?.[col.name] ||
                             projectItemMappings.collections?.certificate?.[col.name] ||
                             projectItemMappings.collections?.donation?.[col.name] || {};
                }

                if (mapping && mapping.oldTable && mapping.oldColumn && mapping.convertType !== 'const') {
                    loadProjectItemColumnDropdown(col.name, mapping.oldTable, mapping.oldColumn);
                }
            });
        }

        async function onProjectItemTableSelected(fieldName) {
            const tableSelect = document.getElementById(`item_table_${fieldName}`);
            const columnSelect = document.getElementById(`item_column_${fieldName}`);
            const selectedTable = tableSelect.value;

            if (!selectedTable) {
                columnSelect.disabled = true;
                columnSelect.innerHTML = '<option value="">-- Select Column --</option>';
                return;
            }

            await loadProjectItemColumnDropdown(fieldName, selectedTable);
        }

        async function loadProjectItemColumnDropdown(fieldName, selectedTable, preselectedColumn = null) {
            const columnSelect = document.getElementById(`item_column_${fieldName}`);

            // Load table data if not cached
            if (!oldTablesData[selectedTable]) {
                try {
                    const response = await fetch(`/api/old-table/${selectedTable}`);
                    oldTablesData[selectedTable] = await response.json();
                } catch (error) {
                    console.error('Error loading table:', error);
                    return;
                }
            }

            // Populate column dropdown
            const tableData = oldTablesData[selectedTable];
            columnSelect.disabled = false;
            columnSelect.innerHTML = '<option value="">-- Select Column --</option>' +
                tableData.columns.map(col =>
                    `<option value="${col.name}" ${preselectedColumn === col.name ? 'selected' : ''}>${col.name}: ${col.type}</option>`
                ).join('');

            // Set up onchange handler
            columnSelect.onchange = () => {
                if (columnSelect.value) {
                    saveProjectItemMapping(fieldName, {
                        convertType: 'direct',
                        oldTable: selectedTable,
                        oldColumn: columnSelect.value
                    });
                }
            };

            // If preselected, trigger the mapping
            if (preselectedColumn) {
                saveProjectItemMapping(fieldName, {
                    convertType: 'direct',
                    oldTable: selectedTable,
                    oldColumn: preselectedColumn
                });
            }
        }

        function saveProjectItemMapping(fieldName, mappingData) {
            // Save to all 3 structures (funds, certificate, donation) to maintain consistency
            // This ensures the mapping works for all project types

            // Ensure structures exist
            if (!projectItemMappings.funds) projectItemMappings.funds = {};
            if (!projectItemMappings.collections) projectItemMappings.collections = {};
            if (!projectItemMappings.collections.certificate) projectItemMappings.collections.certificate = {};
            if (!projectItemMappings.collections.donation) projectItemMappings.collections.donation = {};

            // Initialize field in all structures
            if (!projectItemMappings.funds[fieldName]) {
                projectItemMappings.funds[fieldName] = {};
            }
            if (!projectItemMappings.collections.certificate[fieldName]) {
                projectItemMappings.collections.certificate[fieldName] = {};
            }
            if (!projectItemMappings.collections.donation[fieldName]) {
                projectItemMappings.collections.donation[fieldName] = {};
            }

            // Update all structures with the mapping data
            Object.assign(projectItemMappings.funds[fieldName], mappingData);
            Object.assign(projectItemMappings.collections.certificate[fieldName], mappingData);
            Object.assign(projectItemMappings.collections.donation[fieldName], mappingData);

            console.log('ProjectItem mappings updated:', projectItemMappings);
        }

        function onProjectItemDefaultChanged(fieldName, value) {
            saveProjectItemMapping(fieldName, { defaultValue: value || null });
        }

        function onProjectItemExpressionChanged(fieldName, value) {
            const expression = value.trim();
            if (expression) {
                saveProjectItemMapping(fieldName, {
                    expression: expression,
                    convertType: 'expression'
                });
            } else {
                // Remove expression if empty from all structures
                if (projectItemMappings.funds?.[fieldName]) {
                    delete projectItemMappings.funds[fieldName].expression;
                    if (projectItemMappings.funds[fieldName].convertType === 'expression' &&
                        projectItemMappings.funds[fieldName].oldColumn) {
                        projectItemMappings.funds[fieldName].convertType = 'direct';
                    }
                }
                if (projectItemMappings.collections?.certificate?.[fieldName]) {
                    delete projectItemMappings.collections.certificate[fieldName].expression;
                    if (projectItemMappings.collections.certificate[fieldName].convertType === 'expression' &&
                        projectItemMappings.collections.certificate[fieldName].oldColumn) {
                        projectItemMappings.collections.certificate[fieldName].convertType = 'direct';
                    }
                }
                if (projectItemMappings.collections?.donation?.[fieldName]) {
                    delete projectItemMappings.collections.donation[fieldName].expression;
                    if (projectItemMappings.collections.donation[fieldName].convertType === 'expression' &&
                        projectItemMappings.collections.donation[fieldName].oldColumn) {
                        projectItemMappings.collections.donation[fieldName].convertType = 'direct';
                    }
                }
            }
            console.log(`Expression updated for ${fieldName}:`, expression);
        }

        function onProjectItemConstChanged(fieldName, value) {
            saveProjectItemMapping(fieldName, {
                convertType: 'const',
                value: value
            });
        }

        function setItemExampleExpression(fieldName, type) {
            const textarea = document.getElementById(`item_expression_${fieldName}`);
            if (!textarea) return;

            let exampleCode = '';

            switch(type) {
                case 'truncate':
                    exampleCode = 'value ? value.substring(0, 150) : null';
                    break;
                case 'nullIfZero':
                    exampleCode = 'value === 0 ? null : value';
                    break;
                case 'orDefault':
                    exampleCode = 'value || 0';
                    break;
                default:
                    exampleCode = '';
            }

            textarea.value = exampleCode;

            // Trigger the change event to save it
            onProjectItemExpressionChanged(fieldName, exampleCode);
        }
    </script>
</body>
</html>
